# Тесты Watson

## Текущие тесты

- **Моки без Discord/Whisper** — в `conftest.py` подменяются `discord`, `faster_whisper`, `psutil`; `main` импортируется без токена и без загрузки модели.
- **Логика** — `build_transcript_lines`, лимиты записи, отклонения команд (`!record` без голоса, при идёт транскрипции в той же гильдии).
- **Конкурентные записи в разных гильдиях** — проверяется, что блокировка «идёт транскрипция» действует только внутри одной гильдии: пока гильдия A в транскрипции, гильдия B может запустить `!record` (см. `test_record_allowed_other_guild_while_one_transcribing`).

Запуск: из корня проекта `pytest tests/ -v`.

## Как тестировать одновременные записи в разных каналах

### 1. Программно (моки, без реального Discord)

- **Уже есть:** тесты выше проверяют, что разные гильдии не блокируют друг друга по `transcribing_guilds`.
- **Расширить:** можно добавить тест, который дергает `once_done` для двух гильдий параллельно (`asyncio.gather`), с моками:
  - `sink` с `audio_data = {user_id: MockAudio(bytes)}`;
  - `channel` с `guild.id`, `guild.name`, `channel.name`;
  - подмена `model.transcribe` и записи в файл, чтобы не вызывать реальный Whisper.
- Цель: убедиться, что два одновременных `once_done` не мешают друг другу (разные `temp_guild_dir`, разные `guild_id` в `transcribing_guilds`).

Ботов-имитаторов писать не нужно: достаточно моков объектов discord.py и вызова реальных функций `record`, `once_done` и т.д.

### 2. Вручную с реальным ботом

- Два сервера (или два голосовых канала в одном сервере — но тогда один бот в одном канале, поэтому два сервера нагляднее).
- В каждом: зайти в голос, `!join`, `!record`. Выйти из канала в одном сервере — бот должен обработать только эту запись и выйти только из этого канала; во втором запись продолжается.

Это проверяет реальное поведение Discord и голосовых сокетов без автоматизации.
